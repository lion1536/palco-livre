<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Meus Pedidos - Palco Livre</title>
    <link rel="stylesheet" href="pedidos.css" />
  </head>
  <body>
    <header>
      <h1>Meus Pedidos</h1>
      <button id="btnLogout">Sair</button>
    </header>

    <main>
      <section class="pedidos-container" id="pedidosContainer">
        <!-- Pedidos serão carregados aqui -->
      </section>
    </main>

    <script type="module" src="pedidos.js" defer></script>

    <script type="module">
      const API_URL = "http://localhost:3000";
      const token = localStorage.getItem("token");
      const pedidosContainer = document.getElementById("pedidosContainer");
      const btnLogout = document.getElementById("btnLogout");

      if (!token) window.location.href = "login.html";

      btnLogout.addEventListener("click", () => {
        localStorage.removeItem("token");
        window.location.href = "login.html";
      });

      async function carregarPedidos() {
        try {
          const res = await fetch(`${API_URL}/pedidos`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          if (!res.ok) throw new Error("Erro ao listar pedidos");
          const pedidos = await res.json();
          renderPedidos(pedidos);
        } catch (err) {
          console.error(err);
          pedidosContainer.innerHTML =
            "<p>Erro ao carregar pedidos. Tente novamente.</p>";
        }
      }

      function renderPedidos(pedidos) {
        pedidosContainer.innerHTML = "";
        if (!pedidos.length) {
          pedidosContainer.innerHTML =
            "<p>Você ainda não fez nenhum pedido.</p>";
          return;
        }

        pedidos.forEach((pedido) => {
          const div = document.createElement("div");
          div.classList.add("pedido-card");

          let itensHTML = "";
          if (pedido.itens && pedido.itens.length) {
            itensHTML =
              "<ul>" +
              pedido.itens
                .map(
                  (i) =>
                    `<li>${i.nome} x${i.quantidade} - R$ ${Number(
                      i.preco
                    ).toFixed(2)}</li>`
                )
                .join("") +
              "</ul>";
          }

          div.innerHTML = `
          <h3>Pedido #${pedido.pedido_id}</h3>
          <p>Status Entrega: ${pedido.status_entrega}</p>
          <p>Status Pagamento: ${pedido.status_pagamento}</p>
          <p>Compra ID: ${pedido.compra_id}</p>
          <div>Itens: ${itensHTML}</div>
          <button class="cancelar-btn" data-id="${pedido.pedido_id}">Cancelar Pedido</button>
        `;
          pedidosContainer.appendChild(div);
        });

        // Adiciona evento para cancelar pedido
        document.querySelectorAll(".cancelar-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const id = btn.dataset.id;
            if (!confirm("Deseja realmente cancelar este pedido?")) return;
            try {
              const res = await fetch(`${API_URL}/pedidos/${id}`, {
                method: "DELETE",
                headers: { Authorization: `Bearer ${token}` },
              });
              const data = await res.json();
              if (res.ok) {
                alert(data.message);
                carregarPedidos();
              } else {
                alert(data.error || "Erro ao cancelar pedido");
              }
            } catch (err) {
              console.error(err);
              alert("Erro ao cancelar pedido");
            }
          });
        });
      }

      carregarPedidos();
    </script>
  </body>
</html>
