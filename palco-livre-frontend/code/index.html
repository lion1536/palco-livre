<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Palco Livre - Busca</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="busca.css" />
  </head>
  <body>
    <script src="carrinho.js" type="module" defer></script>
    <script src="busca.js" type="module" defer></script>

    <!-- Header -->
    <header class="cabecalho">
      <div id="svgs">
        <a href="index.html">
          <img src="../images/image.png" alt="Palco Livre" width="120" />
        </a>
        <div id="semnome">
          <a href="login.html">
            <img
              src="../images/profile-svgrepo-com (1).svg"
              alt="Perfil"
              width="50"
            />
          </a>
          <a href="Carrinho.html">
            <img
              src="../images/shop-cart-svgrepo-com (2).svg"
              alt="Carrinho"
              width="50"
            />
          </a>
        </div>
      </div>
    </header>

    <!-- Main / Busca -->
    <main>
      <div id="busca">
        <div id="filtros" class="filtros-container">
          <!-- Input de busca -->
          <input
            type="text"
            id="input-nome"
            placeholder="Buscar instrumento..."
          />

          <!-- Filtros como bot√µes -->
          <div id="filtros-categoria">
            <p>Categoria:</p>
            <button class="filtro" data-categoria="Cordas">Cordas</button>
            <button class="filtro" data-categoria="Sopro">Sopro</button>
            <button class="filtro" data-categoria="El√©tricos">El√©tricos</button>
            <button class="filtro" data-categoria="Acess√≥rios">
              Acess√≥rios
            </button>
            <button class="filtro" data-categoria="Teclas">Teclas</button>
            <button class="filtro" data-categoria="Percuss√£o">Percuss√£o</button>
          </div>

          <div id="filtros-preco">
            <p>Pre√ßo:</p>
            <button
              class="filtro-preco"
              data-preco-min="0"
              data-preco-max="1000"
            >
              At√© 1000
            </button>
            <button
              class="filtro-preco"
              data-preco-min="1001"
              data-preco-max="5000"
            >
              1001 - 5000
            </button>
            <button
              class="filtro-preco"
              data-preco-min="5001"
              data-preco-max="10000"
            >
              5001 - 10000
            </button>
          </div>

          <button id="btn-buscar">Buscar üîç</button>
        </div>

        <p id="relacionados">Todos os instrumentos:</p>
        <div id="container">
          <!-- Cards aparecer√£o aqui -->
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer>
      <div class="center">
        <div class="redes">
          <p>Redes Sociais</p>
          <button class="Sociais">Instagram</button>
          <button class="Sociais">Tiktok</button>
          <button class="Sociais">Facebook</button>
          <button class="Sociais">Youtube</button>
          <button class="Sociais">Twitter</button>
        </div>
      </div>
    </footer>

    <!-- Script de busca -->
    <script type="module">
      import { adicionarAoCarrinho } from "./carrinho.js";

      document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("token");
        const container = document.getElementById("container");
        const inputNome = document.getElementById("input-nome");
        const btnBuscar = document.getElementById("btn-buscar");
        const relacionados = document.getElementById("relacionados");
        const botoesCategoria = document.querySelectorAll(".filtro");
        const botoesPreco = document.querySelectorAll(".filtro-preco");

        let filtroCategoria = null;
        let filtroPreco = null;

        const instrumentos = [
          {
            id: 1,
            nome: "Saxofone Tenor",
            categoria: "Sopro",
            preco: 7870,
            imagem: "../images/download.jpg",
          },
        ];

        function renderInstrumentos(lista) {
          container.innerHTML = "";
          if (!lista.length) {
            container.innerHTML =
              '<p class="nenhum">Nenhum instrumento encontrado.</p>';
            return;
          }

          lista.forEach((item) => {
            const div = document.createElement("div");
            div.classList.add("card-instrumento");
            div.innerHTML = `
              <img src="${item.imagem}" alt="${
              item.nome
            }" class="img-instrumento"/>
              <div class="info">
                <h3>${item.nome}</h3>
                <p>Categoria: ${item.categoria}</p>
                <p>Pre√ßo: R$ ${Number(item.preco).toFixed(2)}</p>
              </div>
              <button class="btn-adicionar" data-id="${
                item.id
              }">Adicionar ao Carrinho</button>
            `;
            container.appendChild(div);
          });

          container.querySelectorAll(".btn-adicionar").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const instrumentoId = btn.dataset.id;
              try {
                await adicionarAoCarrinho(token, instrumentoId, 1);
                alert("Item adicionado ao carrinho!");
              } catch (err) {
                alert("Erro ao adicionar ao carrinho: " + err.message);
              }
            });
          });
        }

        function filtrarInstrumentos() {
          const termo = inputNome.value.toLowerCase();

          const filtrados = instrumentos.filter((item) => {
            const correspondeNome = item.nome.toLowerCase().includes(termo);
            const correspondeCategoria = filtroCategoria
              ? item.categoria === filtroCategoria
              : true;
            const correspondePreco = filtroPreco
              ? item.preco >= filtroPreco.min && item.preco <= filtroPreco.max
              : true;
            return correspondeNome && correspondeCategoria && correspondePreco;
          });

          renderInstrumentos(filtrados);

          const filtrosAplicados = [
            termo || null,
            filtroCategoria || null,
            filtroPreco ? `${filtroPreco.min}-${filtroPreco.max}` : null,
          ]
            .filter(Boolean)
            .join(", ");

          relacionados.textContent = filtrosAplicados
            ? `Resultados relacionados a: ${filtrosAplicados}`
            : "Todos os instrumentos:";
        }

        // Eventos
        btnBuscar.addEventListener("click", filtrarInstrumentos);
        inputNome.addEventListener("keyup", (e) => {
          if (e.key === "Enter") filtrarInstrumentos();
        });

        botoesCategoria.forEach((btn) => {
          btn.addEventListener("click", () => {
            filtroCategoria =
              filtroCategoria === btn.dataset.categoria
                ? null
                : btn.dataset.categoria;
            botoesCategoria.forEach((b) =>
              b.classList.toggle(
                "ativo",
                b.dataset.categoria === filtroCategoria
              )
            );
            filtrarInstrumentos();
          });
        });

        botoesPreco.forEach((btn) => {
          btn.addEventListener("click", () => {
            filtroPreco =
              filtroPreco === btn.dataset
                ? null
                : {
                    min: Number(btn.dataset.precoMin),
                    max: Number(btn.dataset.precoMax),
                  };
            botoesPreco.forEach((b) => b.classList.toggle("ativo", b === btn));
            filtrarInstrumentos();
          });
        });

        renderInstrumentos(instrumentos);
      });
    </script>
  </body>
</html>
